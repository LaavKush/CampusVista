<!DOCTYPE html>
<html lang="en">
<head>
    <title>Campus Geo-Explorer: Services & 360Â° View</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Tailwind CSS for modern aesthetics and responsiveness -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <!-- 1. Leaflet CSS (MANDATORY) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <!-- 2. Leaflet Routing Machine CSS (REQUIRED for directions) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />

    <!-- 3. Three.js for 360Â° Panorama Simulation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f7f9fb;
        }
        .main-container {
            display: flex;
            gap: 1rem;
            max-width: 100%;
            margin: 0 auto;
        }
        #sidebar {
            width: 280px;
            flex-shrink: 0;
            transition: all 0.3s ease-in-out;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            max-height: calc(100vh - 3rem);
        }
        #sidebar.collapsed {
            width: 56px;
            overflow: hidden;
        }
        #map-area {
            flex-grow: 1;
            min-width: 300px;
        }
        #map {
            height: calc(100vh - 400px); 
            width: 100%;
            border-radius: 0.75rem; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
        }
        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
                gap: 0;
            }
            #sidebar {
                width: 100%;
                max-height: 250px;
                margin-bottom: 1rem;
            }
            #sidebar.collapsed {
                height: 56px;
                width: 100%;
            }
            #map {
                height: 50vh;
            }
        }
        
        /* Custom Icons and Effects */
        .pegman-icon {
            background-color: #f59e0b; 
            border-radius: 50%;
            width: 30px;
            height: 30px;
            text-align: center;
            line-height: 30px;
            font-size: 16px;
            color: white;
            border: 3px solid #7c2d12; 
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            transform: translate(-50%, -50%); 
        }
        
        /* 360 Viewer Modal */
        #panorama-modal, #services-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        #panorama-viewer {
            width: 90vw;
            height: 90vh;
            max-width: 1200px;
            max-height: 800px;
            border-radius: 1rem;
            overflow: hidden;
            position: relative;
        }
        #services-modal-content {
            background-color: #fff;
            width: 95vw;
            max-width: 1400px;
            height: 95vh;
            border-radius: 1rem;
            padding: 2rem;
            overflow-y: auto;
            position: relative;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <header class="text-center mb-6">
        <h1 class="text-3xl font-extrabold text-gray-800">Campus Geo-Explorer</h1>
        <p class="text-gray-500 mt-1">Explore campus services and virtual tours.</p>
    </header>

    <!-- 360 Panorama Modal -->
    <div id="panorama-modal">
        <div id="panorama-viewer">
            <h2 id="panorama-title" class="absolute top-4 left-4 text-white text-2xl font-bold z-10"></h2>
            <button id="close-panorama-button" class="absolute top-4 right-4 bg-red-600 hover:bg-red-700 text-white p-2 rounded-full shadow-lg z-10 w-10 h-10 flex items-center justify-center">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>
    
    <!-- Services Modal -->
    <div id="services-modal">
        <div id="services-modal-content">
            <button id="close-services-button" class="absolute top-4 right-4 bg-red-600 hover:bg-red-700 text-white p-2 rounded-full shadow-lg w-10 h-10 flex items-center justify-center z-20">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 id="services-title" class="text-4xl font-extrabold text-gray-800 mb-6 border-b pb-2"></h2>
            <div id="services-details" class="space-y-8">
                <!-- Content injected here -->
            </div>
        </div>
    </div>

    
    <!-- MAIN CONTENT CONTAINER -->
    <div class="main-container mx-auto max-w-7xl">
        
        <!-- SIDEBAR (Collapsible) -->
        <div id="sidebar" class="p-4">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-bold text-gray-800 sidebar-text">Campus Locations</h2>
                <button id="toggle-sidebar" class="p-2 rounded-full hover:bg-gray-100">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
            </div>

            <!-- Location Menu -->
            <div id="menu-content">
                
                <h3 class="font-semibold text-indigo-600 mt-3 mb-1 sidebar-text">Departments</h3>
                <div class="space-y-1 ml-2" id="department-list">
                    <!-- Department Buttons Injected Here -->
                </div>
                
                <h3 class="font-semibold text-purple-600 mt-3 mb-1 sidebar-text">Other Key Buildings</h3>
                <div class="space-y-1 ml-2" id="building-list">
                    <!-- Other Building Buttons Injected Here -->
                </div>
            </div>
        </div>

        <!-- MAP AND CONTROLS AREA -->
        <div id="map-area">

            <!-- ROUTE SUMMARY PANEL -->
            <div id="route-summary" class="bg-white p-4 rounded-lg shadow-xl border-t-4 border-indigo-500 mb-4 mx-auto hidden">
                <p class="text-lg font-semibold text-gray-700">Route Summary</p>
                <p id="summary-distance" class="text-sm text-gray-600"></p>
                <p id="summary-time" class="text-sm text-gray-600"></p>
            </div>

            <!-- MAIN CONTROL PANEL (Location, POI) -->
            <div id="controls" class="flex flex-wrap justify-center items-center gap-3 mb-4 p-4 bg-white rounded-lg shadow-lg">
                
                <!-- Auto Locate/Manual Set -->
                <button id="locate-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 transform hover:scale-105 flex items-center w-full sm:w-auto text-sm">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Find Me (Auto)
                </button>
                <input type="number" id="lat-input" placeholder="Lat" value="40.7812" step="any" class="p-2 border border-gray-300 rounded-lg w-16 sm:w-24 text-sm">
                <input type="number" id="lng-input" placeholder="Lng" value="-73.9665" step="any" class="p-2 border border-gray-300 rounded-lg w-16 sm:w-24 text-sm">
                <button id="set-manual-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 transform hover:scale-105 w-full sm:w-auto text-sm">
                    Set Manual
                </button>

                <!-- POI Search -->
                <input type="text" id="poi-search-input" placeholder="Search POI (e.g., 'cafe')" class="p-2 border border-gray-300 rounded-lg w-full md:w-48 text-sm focus:ring-indigo-500 focus:border-indigo-500">
                <button id="poi-search-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 transform hover:scale-105 w-full sm:w-auto text-sm">
                    Search POIs
                </button>
            </div>

            <!-- ROUTING SETUP PANEL -->
            <div id="routing-panel" class="mb-4 p-4 bg-gray-100 rounded-lg shadow-inner border-l-4 border-yellow-500">
                <h2 class="text-xl font-bold text-gray-800 mb-3">Custom Routing (Address Search)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <!-- Start Point Setup -->
                    <div class="bg-white p-3 rounded-lg border">
                        <p class="font-semibold text-sm text-green-700 mb-2">Start Point:</p>
                        <input type="text" id="start-address-input" placeholder="Start Address" class="p-2 border border-gray-300 rounded-lg w-full text-sm mb-2">
                        <div class="flex gap-2">
                            <button id="search-route-start-button" class="flex-grow bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-md text-sm transition duration-300">
                                Search & Set Start
                            </button>
                            <button id="set-start-from-current-loc" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-md text-sm transition duration-300 whitespace-nowrap">
                                Use Current Loc
                            </button>
                        </div>
                        <div id="start-coords-display" class="text-xs text-gray-600 mt-2">Not Set</div>
                    </div>
                    <!-- End Point Setup -->
                    <div class="bg-white p-3 rounded-lg border">
                        <p class="font-semibold text-sm text-orange-700 mb-2">End Point:</p>
                        <input type="text" id="end-address-input" placeholder="End Address" class="p-2 border border-gray-300 rounded-lg w-full text-sm mb-2">
                        <button id="search-route-end-button" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-1 px-3 rounded-md text-sm w-full transition duration-300">
                            Search & Set End
                        </button>
                        <div id="end-coords-display" class="text-xs text-gray-600 mt-2">Not Set</div>
                    </div>
                </div>
            </div>

            <div id="map"></div>

        </div> <!-- END map-area -->

    </div> <!-- END main-container -->

    <!-- 4. Leaflet JavaScript (MANDATORY) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- 5. Leaflet Routing Machine JavaScript -->
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    
    <script>
        // --- GLOBAL STATE & CONFIGURATION ---
        let map; // Initialized later
        let userLocationMarker = null; 
        let userAccuracyCircle = null;
        let poiLayerGroup = null; 
        
        let routeStartLatlng = null; 
        let routeEndLatlng = null;
        let routeStartMarker = null;
        let routeEndMarker = null;
        let routingControl; // Initialized later
        let pegmanMarker = null; 

        // Three.js Globals
        let scene, camera, renderer, mesh;
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        let panoramaAnimationId = null;

        // Custom coordinates (simulated New Delhi coordinates used as the central campus area)
        const initialCoords = [28.6139, 77.2090]; 
        const initialZoom = 15; 
        
        // Custom image placeholder function (for professor/HOD cards)
        function getPlaceholderImg(name, width = 150, height = 150) {
            const firstName = name.split(' ')[0] || 'User';
            const seed = name.length % 9 + 1; // Simple deterministic color seed
            const colors = ['4338ca', '059669', 'f59e0b', 'dc2626', '9333ea', '14b8a6', '65a30d', 'f97316', '3b82f6'];
            const color = colors[seed - 1];

            // Use a different aspect ratio for the lab image placeholders
            if (width > 200 && height > 100) {
                 return `https://placehold.co/${width}x${height}/${color}/ffffff?text=${name.replace(/\s/g, '+') + '+View'}`;
            }
            return `https://placehold.co/${width}x${height}/${color}/ffffff?text=${firstName.charAt(0)}`;
        }
const CSE_IT_SYLLABUS_URL = './syllabus.pdf';
        // Campus Data Structure - UPDATED with detailed Lab Information
        const campusLocations = {
            'cse': { 
                name: 'Computer Science & Engineering Block', lat: 28.6145, lng: 77.2100, isDept: true, 
                services: {
                    hod: { name: 'Prof. S. R. N. Reddy', designation: 'HoD CSE, Professor', img: getPlaceholderImg('Prof. S. R. N. Reddy') }, 
                    professors: [ // CSE FACULTY LIST
                        { name: 'Prof. Ela Kumar', designation: 'Professor', img: getPlaceholderImg('Prof. Ela Kumar') },
                        { name: 'Prof. Devendra K. Tayal', designation: 'Professor & Ex- HOD (CSE)', img: getPlaceholderImg('Prof. Devendra K. Tayal') },
                        { name: 'Prof. S. R. N. Reddy', designation: 'HoD CSE, Professor', img: getPlaceholderImg('Prof. S. R. N. Reddy') },
                        { name: 'Prof. K. R. Seeja', designation: 'Professor & Dean (Examination Affairs)', img: getPlaceholderImg('Prof. K. R. Seeja') },
                        { name: 'Prof. Vivekanand Jha', designation: 'Professor', img: getPlaceholderImg('Prof. Vivekanand Jha') },
                        { name: 'Dr. Vibha Pratap', designation: 'Associate Professor', img: getPlaceholderImg('Dr. Vibha Pratap') },
                        { name: 'Mr. B. Indra Thanaya', designation: 'Associate Professor', img: getPlaceholderImg('Mr. B. Indra Thanaya') },
                        { name: 'Ms. Najme Zehra Naqvi', designation: 'Associate Professor', img: getPlaceholderImg('Ms. Najme Zehra Naqvi') },
                        { name: 'Ms. Monika Choudhary', designation: 'Assistant Professor', img: getPlaceholderImg('Ms. Monika Choudhary') },
                        { name: 'Dr. Arunima Jaiswal', designation: 'Assistant Professor', img: getPlaceholderImg('Dr. Arunima Jaiswal') },
                        { name: 'Dr. Ravinder M', designation: 'Assistant Professor', img: getPlaceholderImg('Dr. Ravinder M') },
                        { name: 'Dr. Khyati Ahlawat', designation: 'Assistant Professor', img: getPlaceholderImg('Dr. Khyati Ahlawat') },
                        { name: 'Ms. Karuna Kadian', designation: 'Assistant Professor', img: getPlaceholderImg('Ms. Karuna Kadian') },
                        { name: 'Ms. Bhawna Jain', designation: 'Assistant Professor', img: getPlaceholderImg('Ms. Bhawna Jain') },
                        { name: 'Dr. Vijay Kumar Yadav', designation: 'Assistant Professor', img: getPlaceholderImg('Dr. Vijay Kumar Yadav') },
                        { name: 'Dr. Jagrati Singh', designation: 'Assistant Professor', img: getPlaceholderImg('Dr. Jagrati Singh') },
                        { name: 'Dr. Anjali Lathwal', designation: 'Assistant Professor', img: getPlaceholderImg('Dr. Anjali Lathwal') },
                    ],
                    syllabus: {
                         'Semester Syllabus' : {  PDFurl: 'file:///C:/Users/thech/OneDrive/Desktop/syllabus.pdf'
                    }
                    },
                    about_summary: 'The CSE department is a research and innovation hub, equipped with foundational and advanced laboratory facilities, including dedicated Physics and BEE Labs, supporting core engineering principles.',
                    // UPDATED CSE LABS LIST WITH NEW DATA
                    labs: [
                        { 
                            name: 'DBMS (Database Management System) Lab', 
                            incharge: 'Dr. Vijay Kr. Yadav', 
                            assistant: 'Ms. Aarti Gambhir', 
                            location: 'Ground Floor, CSE Department', 
                            img: getPlaceholderImg('DBMS Lab', 400, 200) 
                        },
                        { 
                            name: 'Networking Lab', 
                            incharge: 'Ms. Bhawna Jain', 
                            assistant: 'Mr K. Bala Chandar', 
                            location: 'Ground Floor, CSE Department', 
                            img: getPlaceholderImg('Networking Lab', 400, 200) 
                        },
                        { 
                            name: 'Design & Innovation Centre (DIC)', 
                            incharge: 'Dr. SRN Reddy', 
                            assistant: 'Mr K. Bala Chandar', 
                            location: 'CSE Block (Specific location pending)', 
                            img: getPlaceholderImg('DIC Lab', 400, 200) 
                        },
                        { 
                            name: 'Machine Learning & Deep Learning Lab', 
                            incharge: 'Ms. Karuna Kadian', 
                            assistant: 'Ms. Aarti Gambhir', 
                            location: 'CSE Block (Specific location pending)', 
                            img: getPlaceholderImg('ML/DL Lab', 400, 200) 
                        }
                    ]
                }
            },
            'it': { 
                name: 'Information Technology Block', lat: 28.6150, lng: 77.2085, isDept: true,
                services: {
                    hod: { name: 'Prof. A.K. Mohapatra', designation: 'Professor and HoD', img: getPlaceholderImg('Prof. A.K. Mohapatra') },
                    professors: [
                        { name: 'Prof. R. K. Singh', designation: 'Professor & Dean (Students Welfare)', img: getPlaceholderImg('Prof. R. K. Singh') },
                        { name: 'Prof. Arun Sharma', designation: 'Professor - IT and Dean - Academic Affairs', img: getPlaceholderImg('Prof. Arun Sharma') },
                        { name: 'Prof. Brijesh Kumar', designation: 'Registrar & Director (Planning)', img: getPlaceholderImg('Prof. Brijesh Kumar') },
                        { name: 'Prof. Naveen Prakash', designation: 'Professor (Adjunct)', img: getPlaceholderImg('Prof. Naveen Prakash') },
                        { name: 'Prof. Parimala. N', designation: 'Professor (Adjunct)', img: getPlaceholderImg('Prof. Parimala. N') },
                        { name: 'Dr. Nonita Sharma', designation: 'Associate Professor & Manager(International Affairs)', img: getPlaceholderImg('Dr. Nonita Sharma') },
                        { name: 'Dr. Deepak Kumar Sharma', designation: 'Associate Professor', img: getPlaceholderImg('Dr. Deepak Kumar Sharma') },
                        { name: 'Dr. Kamal Kumar', designation: 'Associate Professor', img: getPlaceholderImg('Dr. Kamal Kumar') },
                        { name: 'Prof. Kalpana Yadav', designation: 'Professor', img: getPlaceholderImg('Prof. Kalpana Yadav') },
                        { name: 'Dr. Rishabh Kaushal', designation: 'Associate Professor, Incharge (ACM Student Chapter)', img: getPlaceholderImg('Dr. Rishabh Kaushal') },
                        { name: 'Dr. Ankita', designation: 'Assistant Professor', img: getPlaceholderImg('Dr. Ankita') },
                        { name: 'Ms. Nidhi Arora', designation: 'Assistant Professor', img: getPlaceholderImg('Ms. Nidhi Arora') },
                        { name: 'Dr. Bhawna Narwal', designation: 'Assistant Professor', img: getPlaceholderImg('Dr. Bhawna Narwal') },
                        { name: 'Dr. Gaurav Indra', designation: 'Assistant Professor', img: getPlaceholderImg('Dr. Gaurav Indra') },
                        { name: 'Dr. Mohona Ghosh', designation: 'Assistant Professor', img: getPlaceholderImg('Dr. Mohona Ghosh') },
                        { name: 'Dr. Alongbar Wary', designation: 'Assistant Professor', img: getPlaceholderImg('Dr. Alongbar Wary') },
                        { name: 'Dr. Shweta Jindal (formerly Shweta Singhal)', designation: 'Assistant Professor', img: getPlaceholderImg('Dr. Shweta Jindal') },
                        { name: 'Dr. Sudhir Singh', designation: 'Assistant Professor', img: getPlaceholderImg('Dr. Sudhir Singh') },
                        { name: 'Ms. Deepika Suhag', designation: 'Assistant Professor', img: getPlaceholderImg('Ms. Deepika Suhag') },
                        { name: 'Dr. Anjum Rathee', designation: 'Assistant Professor', img: getPlaceholderImg('Dr. Anjum Rathee') },
                        { name: 'Dr. Jyoti Shokeen', designation: 'Assistant Professor, Coordinator (Research & Development Cell), Coordinator (SAMARTH ERP portal)', img: getPlaceholderImg('Dr. Jyoti Shokeen') }
                    ],
                    syllabus: {
                        'Semester 1': 'Foundations of IT, Technical Communication, Linear Algebra.',
                        
                    },
                    about_summary: 'The Information Technology Block provides comprehensive, hands-on training across foundational and advanced domains, including specialized laboratories for Software Engineering, AI/ML, Networking, and Cyber Security.',
                    labs: [
                        { 
                            name: 'Software Engineering & Programming Lab', 
                            incharge: 'Dr. Shweta Singhal', 
                            assistant: 'Mr. Ajay Nain', 
                            location: 'Room No 209 First Floor, IT Block', 
                            img: getPlaceholderImg('Software Engineering Lab', 400, 200) 
                        },
                        { 
                            name: 'Data Structure & DBMS Lab', 
                            incharge: 'Ms. Deepika Suhag', 
                            assistant: 'Mr. Dronacharya, LA-1', 
                            location: 'Room No 301 Second Floor, IT Block', 
                            img: getPlaceholderImg('Data Structure Lab', 400, 200) 
                        },
                        { 
                            name: 'Artificial Intelligence and Machine Learning Lab', 
                            incharge: 'Mr. Sudhir Singh', 
                            assistant: 'Mr. Muninder Singh, LA-1', 
                            location: 'Room No 310 Second Floor, IT Block', 
                            img: getPlaceholderImg('AI/ML Lab', 400, 200) 
                        },
                        { 
                            name: 'Computer Networks Lab', 
                            incharge: 'Dr. Deepak Kumar Sharma', 
                            assistant: 'Mr. Muninder Singh, LA-1', 
                            location: 'Room No 313 Second Floor, IT Block', 
                            img: getPlaceholderImg('Computer Networks Lab', 400, 200) 
                        },
                        { 
                            name: 'Cyber Security & Cloud Computing Lab', 
                            incharge: 'Dr. Jyoti Shokeen', 
                            assistant: 'Mr. Dronacharya, LA-1', 
                            location: 'Room No 401 Third Floor, IT Block', 
                            img: getPlaceholderImg('Cyber Security Lab', 400, 200) 
                        },
                        { 
                            name: 'Data Science & Computer Vision Lab', 
                            incharge: 'N/A', 
                            assistant: 'N/A', 
                            location: 'Ground Floor, IT Block', 
                            img: getPlaceholderImg('Data Science Lab', 400, 200) 
                        },
                        { 
                            name: 'Cyber Security and Software Development Cell', 
                            incharge: 'Dr. Jyoti Shokeen', 
                            assistant: 'Ajay', 
                            location: 'First Floor, Room-213', 
                            img: getPlaceholderImg('Dev Cell Lab', 400, 200) 
                        }
                    ]
                }
            },  
            'ece': { 
                name: 'Electronics & Communication Engineering Block', lat: 28.6135, lng: 77.2095, isDept: true,
                services: {
                    // --- UPDATED HOD ---
                    hod: { name: 'Prof Vandana Niranjan', designation: 'Professor, Head of Department', img: getPlaceholderImg('Prof Vandana Niranjan') },
                    // --- UPDATED FACULTY LIST ---
                    professors: [
                        { name: 'Prof. Ashwni Kumar', designation: 'Professor', img: getPlaceholderImg('Prof. Ashwni Kumar') },
                        { name: 'Prof. Jasdeep Kaur Dhanoa', designation: 'Professor', img: getPlaceholderImg('Prof. Jasdeep Kaur Dhanoa') },
                        { name: 'Prof. Nidhi Goel', designation: 'Professor', img: getPlaceholderImg('Prof. Nidhi Goel') },
                        { name: 'Prof Vandana Niranjan', designation: 'Professor, Head of Department', img: getPlaceholderImg('Prof Vandana Niranjan') },
                        { name: 'Prof. Greeshma Arya', designation: 'Professor', img: getPlaceholderImg('Prof. Greeshma Arya') },
                        { name: 'Dr. Maria Jamal', designation: 'Associate Professor', img: getPlaceholderImg('Dr. Maria Jamal') },
                        { name: 'Prof. Shobha Sharma', designation: 'Professor', img: getPlaceholderImg('Prof. Shobha Sharma') },
                        { name: 'Prof. Pankaj Gupta', designation: 'Professor', img: getPlaceholderImg('Prof. Pankaj Gupta') },
                        { name: 'Prof. Kanchan Sharma', designation: 'Professor', img: getPlaceholderImg('Prof. Kanchan Sharma') },
                        // Simplified the long designation for clean UI display
                        { name: 'Mr. Md. Ejaz Aslam Lodhi', designation: 'Assistant Professor', img: getPlaceholderImg('Mr. Md. Ejaz Aslam Lodhi') }, 
                        { name: 'Dr. Richa Yadav', designation: 'Assistant Professor', img: getPlaceholderImg('Dr. Richa Yadav') },
                        { name: 'Ms. Neha Singh', designation: 'Assistant Professor', img: getPlaceholderImg('Ms. Neha Singh') },
                    ],
                    // --- LABS and SYLLABUS remain the same ---
                    syllabus: {
                        'Semester 1': 'Basic Electronics, Calculus, Engineering Drawing.',
                       
                    },
                    about_summary: 'The ECE block is a major hub for hardware-software integration projects, housing specialized labs for signal processing and embedded systems design.',
                    // --- UPDATED ECE LABS LIST ---
                    labs: [
                        { 
                            name: 'Computer Vision and Image Processing Lab', 
                            incharge: 'Faculty Assigned', 
                            assistant: 'TA/STA', 
                            location: 'ECE Block, Room TBD', 
                            img: getPlaceholderImg('Computer Vision Lab', 400, 200) 
                        },
                        { 
                            name: 'Digital Signal Processing and VLSI Design Lab', 
                            incharge: 'Faculty Assigned', 
                            assistant: 'TA/STA', 
                            location: 'ECE Block, Room TBD', 
                            img: getPlaceholderImg('DSP/VLSI Lab', 400, 200) 
                        },
                        { 
                            name: 'Communication System Lab', 
                            incharge: 'Faculty Assigned', 
                            assistant: 'TA/STA', 
                            location: 'ECE Block, Room TBD', 
                            img: getPlaceholderImg('Communication Lab', 400, 200) 
                        },
                        { 
                            name: 'Digital Communication System Lab', 
                            incharge: 'Faculty Assigned', 
                            assistant: 'TA/STA', 
                            location: 'ECE Block, Room TBD', 
                            img: getPlaceholderImg('Digital Communication Lab', 400, 200) 
                        },
                        { 
                            name: 'Basic Electrical Engineering Lab', 
                            incharge: 'Faculty Assigned', 
                            assistant: 'TA/STA', 
                            location: 'ECE Block, Room TBD', 
                            img: getPlaceholderImg('BEE Lab', 400, 200) 
                        },
                        { 
                            name: 'Network Analysis and Synthesis Lab', 
                            incharge: 'Faculty Assigned', 
                            assistant: 'TA/STA', 
                            location: 'ECE Block, Room TBD', 
                            img: getPlaceholderImg('Network Analysis Lab', 400, 200) 
                        },
                        { 
                            name: 'Analog Electronics Lab', 
                            incharge: 'Faculty Assigned', 
                            assistant: 'TA/STA', 
                            location: 'ECE Block, Room TBD', 
                            img: getPlaceholderImg('Analog Electronics Lab', 400, 200) 
                        },
                        { 
                            name: 'Linear Integrated Circuits Lab', 
                            incharge: 'Faculty Assigned', 
                            assistant: 'TA/STA', 
                            location: 'ECE Block, Room TBD', 
                            img: getPlaceholderImg('LIC Lab', 400, 200) 
                        },
                        { 
                            name: 'Microwave and Radar Engineering Lab', 
                            incharge: 'Faculty Assigned', 
                            assistant: 'TA/STA', 
                            location: 'ECE Block, Room TBD', 
                            img: getPlaceholderImg('Microwave Lab', 400, 200) 
                        },
                        { 
                            name: 'Digital Electronics lab', 
                            incharge: 'Faculty Assigned', 
                            assistant: 'TA/STA', 
                            location: 'ECE Block, Room TBD', 
                            img: getPlaceholderImg('Digital Electronics Lab', 400, 200) 
                        },
                    ]
                }
            },
            'mae': { 
                name: 'Mechanical & Automotive Engineering Block', lat: 28.6140, lng: 77.2080, isDept: true,
                services: {
                    hod: { name: 'Dr. O.K Singh', designation: ' HOD, MAE', img: getPlaceholderImg('Prof. David Chen') },
                    professors: [
                        { name: 'Prof. Manoj Soni', designation: 'Sr. Professor, MAE', img: getPlaceholderImg('Dr. Helen Cho') },
                        { name: 'Prof. Arvind Kr. Jayant', designation: ' Professor, Former HOD', img: getPlaceholderImg('Prof. Vikas Gupta') },
                        { name: 'Prof. Nathi Ram Chauhan', designation: 'Former HOD, MAE', img: getPlaceholderImg('Prof. David Chen') },
                        { name: 'Dr. Subhash Singh', designation: 'Assis.Professor , Deputy Registrar', img: getPlaceholderImg('Prof. David Chen') },
                        { name: 'Dr. Deepti Chhabra', designation: 'Assist.Professor , Incharge', img: getPlaceholderImg('Prof. David Chen') },
                        { name: 'Dr. Vivek Chawla', designation: 'Assist. Professor', img: getPlaceholderImg('Prof. David Chen') },
                        { name: 'Ms. Deepti Jaiswal', designation: 'Assist. Professor', img: getPlaceholderImg('Prof. David Chen') },
                        { name: 'Dr. Pooja Bhati', designation: 'Assist.Professor', img: getPlaceholderImg('Prof. David Chen') },
                        { name: 'Dr. Tina Chaudhary', designation: 'Assist.Professor', img: getPlaceholderImg('Prof. David Chen') },

                    ],
                    syllabus: {
                        'Semester 1': 'Applied Mechanics, Workshop Practices, Material Science.',
                

                    },
                    about_summary: 'MAE features state-of-the-art facilities like the Automotive Workshop and CAD/CAM Center for comprehensive hands-on mechanical and design experience.',
                    labs: [
                        { name: 'Automotive Workshop', assistant: 'Mr. Jamal Hassan', location: 'Ground Floor, Workshop Area 1, MAE-Block', img: getPlaceholderImg('Automotive Workshop', 400, 200) },
                        { name: 'Theory Of Machine', assistant: 'Ms. Lin Wei', location: '2nd Floor, Room No. 201, MAE-Block', img: getPlaceholderImg('CAD Center', 400, 200) },
                         { name: 'CAD/CAM Center', assistant: 'Ms. Lin Wei', location: '2nd Floor, Room No. 201, MAE-Block', img: getPlaceholderImg('CAD Center', 400, 200) },
                          { name: 'Metrology Lab', assistant: 'Ms. Lin Wei', location: '2nd Floor, Room No. 201, MAE-Block', img: getPlaceholderImg('CAD Center', 400, 200) },
                           { name: 'Thermal Engineering Lab', assistant: 'Ms. Lin Wei', location: '2nd Floor, Room No. 201, MAE-Block', img: getPlaceholderImg('CAD Center', 400, 200) },
                            { name: 'Graphics Lab', assistant: 'Ms. Lin Wei', location: 'Ground Floor, MAE-Block', img: getPlaceholderImg('CAD Center', 400, 200) },

                    ]
                }
            },
            // Non-departmental buildings (no "Services" button)
            'admin': { name: 'Admin & Examination Block', lat: 28.6155, lng: 77.2090, isDept: false },
            'library': { name: 'Central Library', lat: 28.6130, lng: 77.2090, isDept: false },
            'gce': { name: 'General Classroom East Block', lat: 28.6148, lng: 77.2097, isDept: false },
            'gazebo': { name: 'Student Gazebo Area', lat: 28.6138, lng: 77.2088, isDept: false }
        };

        // --- MAP INITIALIZATION ---
        function initializeMap() {
            map = L.map('map').setView(initialCoords, initialZoom);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            poiLayerGroup = L.layerGroup().addTo(map);

            // PEGMAN (Campus View Marker)
            const pegmanIcon = L.divIcon({
                className: 'pegman-icon',
                html: 'ðŸš¶',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            pegmanMarker = L.marker(initialCoords, { icon: pegmanIcon }).addTo(map)
                .bindPopup("<b>Pegman Location</b><br>Click 'Map (360Â° View)' to launch panorama.");

            // Routing Control Setup
            routingControl = L.Routing.control({
                waypoints: [], routeWhileDragging: true, showAlternatives: false, collapsible: true,
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1'
                })
            }).addTo(map);
            routingControl.on('routesfound', function(e) {
                const summary = e.routes[0].summary;
                document.getElementById('route-summary').classList.remove('hidden');
                document.getElementById('summary-distance').textContent = `Total Distance: ${summary.totalDistance < 1000 ? summary.totalDistance.toFixed(0) + ' m' : (summary.totalDistance / 1000).toFixed(1) + ' km'}`;
                document.getElementById('summary-time').textContent = `Estimated Time: ${Math.floor(summary.totalTime / 60)} min`;
            });
        }
        
        // --- ROUTING / GEOCODING FUNCTIONS ---
        function updateRouting() {
            routingControl.setWaypoints([]); // Clear existing routes
            if (routeStartMarker) map.removeLayer(routeStartMarker);
            if (routeEndMarker) map.removeLayer(routeEndMarker);
            
            if (routeStartLatlng && routeEndLatlng) {
                // Add temporary markers
                routeStartMarker = L.marker(routeStartLatlng, {icon: L.divIcon({className: 'bg-green-600 rounded-full w-4 h-4 text-white text-xs text-center font-bold', html: 'A'})}).addTo(map);
                routeEndMarker = L.marker(routeEndLatlng, {icon: L.divIcon({className: 'bg-orange-600 rounded-full w-4 h-4 text-white text-xs text-center font-bold', html: 'B'})}).addTo(map);

                routingControl.setWaypoints([L.Routing.waypoint(routeStartLatlng, 'Start'), L.Routing.waypoint(routeEndLatlng, 'End')]);
            } else {
                document.getElementById('route-summary').classList.add('hidden');
            }
        }

        async function searchAddress(address, isStart) {
            if (!address) return;
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
                const data = await response.json();

                if (data && data.length > 0) {
                    const latlng = L.latLng(data[0].lat, data[0].lon);
                    
                    if (isStart) {
                        routeStartLatlng = latlng;
                        document.getElementById('start-coords-display').textContent = `Set: ${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`;
                    } else {
                        routeEndLatlng = latlng;
                        document.getElementById('end-coords-display').textContent = `Set: ${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`;
                        map.setView(latlng, 15);
                    }
                    updateRouting();
                } else {
                    console.error("Address not found.");
                    // Use a message box/toast instead of alert
                }
            } catch (error) {
                console.error("Geocoding failed:", error);
            }
        }
        
        async function searchPOI() {
            const query = document.getElementById('poi-search-input').value;
            if (!query) return;

            poiLayerGroup.clearLayers(); // Clear previous markers

            try {
                // Use Overpass API for POIs near the map center for better relevance
                // NOTE: This uses Nominatim for a broad search since Overpass is complex for a single file.
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=10&bounded=1&viewbox=${map.getBounds().toBBoxString()}`);
                const data = await response.json();

                data.forEach(item => {
                    const latlng = L.latLng(item.lat, item.lon);
                    L.marker(latlng).addTo(poiLayerGroup)
                        .bindPopup(`<b>POI Found:</b> ${item.display_name}`)
                        .openPopup();
                });

                if (data.length > 0) {
                    map.fitBounds(poiLayerGroup.getBounds());
                } else {
                    console.log("No POIs found.");
                }

            } catch (error) {
                console.error("POI search failed:", error);
            }
        }

        // --- GEOLOCATION FUNCTIONS ---
        function locateUser() {
            if (!navigator.geolocation) {
                console.error("Geolocation is not supported by your browser");
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    const latlng = L.latLng(lat, lng);

                    if (userLocationMarker) {
                        map.removeLayer(userLocationMarker);
                        map.removeLayer(userAccuracyCircle);
                    }

                    userLocationMarker = L.marker(latlng).addTo(map)
                        .bindPopup("You are here").openPopup();
                    userAccuracyCircle = L.circle(latlng, { radius: accuracy, color: '#10b981', fillColor: '#34d399', fillOpacity: 0.2 }).addTo(map);

                    map.setView(latlng, 15);
                    
                    // Update manual inputs
                    document.getElementById('lat-input').value = lat.toFixed(5);
                    document.getElementById('lng-input').value = lng.toFixed(5);
                },
                (error) => {
                    console.error(`Geolocation error: ${error.message}`);
                }
            );
        }

        function setManualLocation() {
            const lat = parseFloat(document.getElementById('lat-input').value);
            const lng = parseFloat(document.getElementById('lng-input').value);

            if (isNaN(lat) || isNaN(lng)) {
                console.error("Invalid latitude or longitude input.");
                return;
            }

            const latlng = L.latLng(lat, lng);

            if (userLocationMarker) {
                map.removeLayer(userLocationMarker);
                if (userAccuracyCircle) map.removeLayer(userAccuracyCircle);
            }

            userLocationMarker = L.marker(latlng).addTo(map)
                .bindPopup("Manually Set Location").openPopup();
            
            map.setView(latlng, 15);
        }

        // --- SERVICES MODAL LOGIC ---
        
        // 1. Complete Lab Card Rendering Helper
        function renderLabCards(key) {
            const loc = campusLocations[key];
            if (!loc.services || !loc.services.labs || loc.services.labs.length === 0) return '';
            
            let cardsHtml = '';
            loc.services.labs.forEach(lab => {
                // Determine if assistant is 'STA' or 'Technical Assistant' and use the 'assistant' field for Senior Technical Assistant (STA)
                const assistantLabel = lab.assistant && lab.assistant.toLowerCase().includes('sta') ? 'STA' : 'Technical Assistant';
                const assistantDisplay = lab.assistant ? `<p class="text-sm text-gray-600 mb-1"><span class="font-semibold text-pink-600">${assistantLabel}:</span> ${lab.assistant}</p>` : '';

                cardsHtml += `
                    <div class="bg-white rounded-xl shadow-xl border-t-4 border-pink-500 overflow-hidden md:flex transform hover:scale-[1.01] transition duration-300">
                        <img src="${lab.img}" alt="${lab.name}" onerror="this.onerror=null;this.src='https://placehold.co/400x200/4338ca/ffffff?text=Lab+View';" class="w-full md:w-1/3 h-40 object-cover">
                        <div class="p-4 flex-grow">
                            <h4 class="text-xl font-bold text-gray-800 mb-2">${lab.name}</h4>
                            <p class="text-sm text-gray-600 mb-1"><span class="font-semibold text-pink-600">Location:</span> ${lab.location}</p>
                            ${lab.incharge ? `<p class="text-sm text-gray-600 mb-1"><span class="font-semibold text-pink-600">Lab In Charge:</span> ${lab.incharge}</p>` : ''}
                            ${assistantDisplay}
                        </div>
                    </div>
                `;
            });
            return cardsHtml;
        }

        // 2. Full Services Modal Generator
        function openServicesModal(key) {
            const loc = campusLocations[key];
            if (!loc || !loc.services) return;

            document.getElementById('services-title').textContent = `${loc.name} Services & Details`;
            const detailsContainer = document.getElementById('services-details');
            
            // Generate HTML for the modal content
            let modalContent = `
                <!-- Summary Section -->
                <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-200">
                    <h3 class="text-2xl font-bold text-indigo-700 mb-2">Department Overview</h3>
                    <p class="text-gray-700">${loc.services.about_summary}</p>
                </div>

                <!-- HOD Section -->
                <div class="bg-red-50 p-6 rounded-xl border border-red-200">
                    <h3 class="text-2xl font-bold text-red-700 mb-4">Head of Department (HOD)</h3>
                    <div class="flex items-center space-x-4">
                        <img src="${loc.services.hod.img}" alt="${loc.services.hod.name}" onerror="this.onerror=null;this.src='${getPlaceholderImg('HOD')}'" class="w-20 h-20 rounded-full object-cover shadow-md">
                        <div>
                            <p class="text-xl font-semibold text-gray-800">${loc.services.hod.name}</p>
                            <p class="text-sm text-red-600">${loc.services.hod.designation}</p>
                        </div>
                    </div>
                </div>

                <!-- Faculty/Professor Section -->
                <div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-4 border-b pb-2">Core Faculty (${loc.services.professors.length} Members)</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${loc.services.professors.map(p => `
                            <div class="bg-gray-50 p-4 rounded-lg shadow-md flex items-center space-x-3">
                                <img src="${p.img}" alt="${p.name}" onerror="this.onerror=null;this.src='${getPlaceholderImg('Faculty')}'" class="w-12 h-12 rounded-full object-cover">
                                <div>
                                    <p class="font-medium text-gray-800">${p.name}</p>
                                    <p class="text-xs text-gray-500">${p.designation}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Labs Section -->
                <div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-4 border-b pb-2">Research & Practical Laboratories</h3>
                    <div class="space-y-4">
                        ${renderLabCards(key)}
                    </div>
                </div>
                
                <!-- Syllabus Section -->
                <div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-4 border-b pb-2">Syllabus Highlights</h3>
                    <div class="space-y-2">
                        ${Object.entries(loc.services.syllabus).map(([sem, topics]) => `
                            <details class="group bg-yellow-50 p-4 rounded-lg cursor-pointer transition duration-200 hover:bg-yellow-100 border border-yellow-200">
                                <summary class="font-semibold text-yellow-800 flex justify-between items-center">
                                    ${sem} Core Subjects
                                    <svg class="w-5 h-5 text-yellow-600 transform group-open:rotate-180 transition duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </summary>
                                <p class="mt-3 pl-4 text-sm text-gray-700 border-l-2 border-yellow-500">${topics}</p>
                            </details>
                        `).join('')}
                    </div>
                </div>
            `;

            detailsContainer.innerHTML = modalContent;
            document.getElementById('services-modal').style.display = 'flex';
        }


        // --- THREE.JS 360 PANORAMA LOGIC ---
        function initPanorama(latlng, title) {
            document.getElementById('panorama-title').textContent = `360Â° View of: ${title}`;
            const container = document.getElementById('panorama-viewer');
            
            // Clear existing scene if running
            if (renderer) {
                cancelAnimationFrame(panoramaAnimationId);
                // Clean up previous canvas
                while (container.firstChild) {
                    container.removeChild(container.firstChild);
                }
                renderer.dispose();
            }

            // Scene setup
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 1, 1100);
            camera.target = new THREE.Vector3(0, 0, 0);
            camera.position.set(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            // Panorama sphere (using a simple color gradient as a placeholder 'texture')
            const geometry = new THREE.SphereGeometry(1000, 60, 40);
            geometry.scale(-1, 1, 1); // Invert sphere for interior view

            // Placeholder material (simulated campus ambiance)
            const material = new THREE.MeshBasicMaterial({
                color: 0x5a67d8, // Indigo base color
                side: THREE.DoubleSide,
                wireframe: false // Set to false for a solid look
            });
            mesh = new THREE.Mesh(geometry, material);
            scene.add(mesh);
            
            // Controls setup (Mouse drag for look around)
            container.addEventListener('mousedown', onMouseDown, false);
            container.addEventListener('mousemove', onMouseMove, false);
            container.addEventListener('mouseup', onMouseUp, false);
            
            // Touch controls for mobile
            container.addEventListener('touchstart', onTouchStart, false);
            container.addEventListener('touchmove', onTouchMove, false);
            container.addEventListener('touchend', onTouchEnd, false);

            window.addEventListener('resize', onWindowResize, false);
            
            document.getElementById('panorama-modal').style.display = 'flex';
            animate();
        }

        function onWindowResize() {
            const container = document.getElementById('panorama-viewer');
            if (camera) {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            }
        }

        // Mouse Handlers
        function onMouseDown(event) {
            isDragging = true;
            previousMousePosition.x = event.clientX;
            previousMousePosition.y = event.clientY;
        }

        function onMouseMove(event) {
            if (!isDragging) return;

            const deltaX = event.clientX - previousMousePosition.x;
            const deltaY = event.clientY - previousMousePosition.y;

            // Simple rotation calculation (adjust sensitivity as needed)
            const rotationSpeed = 0.002;
            mesh.rotation.y += deltaX * rotationSpeed;
            camera.rotation.x += deltaY * rotationSpeed;
            camera.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, camera.rotation.x)); // Limit vertical view

            previousMousePosition.x = event.clientX;
            previousMousePosition.y = event.clientY;
        }

        function onMouseUp() {
            isDragging = false;
        }
        
        // Touch Handlers (Maps touch events to mouse behavior)
        function onTouchStart(event) {
            if (event.touches.length === 1) {
                onMouseDown({ clientX: event.touches[0].clientX, clientY: event.touches[0].clientY });
            }
        }

        function onTouchMove(event) {
            if (event.touches.length === 1) {
                onMouseMove({ clientX: event.touches[0].clientX, clientY: event.touches[0].clientY });
            }
        }

        function onTouchEnd() {
            onMouseUp();
        }

        function animate() {
            panoramaAnimationId = requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        function closePanorama() {
            cancelAnimationFrame(panoramaAnimationId);
            document.getElementById('panorama-modal').style.display = 'none';
        }

        // --- INITIALIZATION AND EVENT SETUP ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();
            renderSidebar();
            
            // Initial map coordinates (used for manual set fallback)
            document.getElementById('lat-input').value = initialCoords[0].toFixed(5);
            document.getElementById('lng-input').value = initialCoords[1].toFixed(5);

            // Button Event Listeners
            document.getElementById('locate-button').addEventListener('click', locateUser);
            document.getElementById('set-manual-button').addEventListener('click', setManualLocation);
            document.getElementById('poi-search-button').addEventListener('click', searchPOI);

            document.getElementById('search-route-start-button').addEventListener('click', () => {
                searchAddress(document.getElementById('start-address-input').value, true);
            });
            document.getElementById('search-route-end-button').addEventListener('click', () => {
                searchAddress(document.getElementById('end-address-input').value, false);
            });
            document.getElementById('set-start-from-current-loc').addEventListener('click', () => {
                if (userLocationMarker) {
                    routeStartLatlng = userLocationMarker.getLatLng();
                    document.getElementById('start-coords-display').textContent = `Set: ${routeStartLatlng.lat.toFixed(4)}, ${routeStartLatlng.lng.toFixed(4)} (Current)`;
                    updateRouting();
                } else {
                    console.log("Please use 'Find Me (Auto)' or 'Set Manual' first.");
                }
            });

            // Modal Close Listeners
            document.getElementById('close-panorama-button').addEventListener('click', closePanorama);
            document.getElementById('close-services-button').addEventListener('click', () => {
                document.getElementById('services-modal').style.display = 'none';
            });
        });

        // --- SIDEBAR INITIALIZATION ---
        const departmentList = document.getElementById('department-list');
        const buildingList = document.getElementById('building-list');
        let activeDepartmentKey = null; 

        function renderSidebar() {
            departmentList.innerHTML = '';
            buildingList.innerHTML = '';

            for (const key in campusLocations) {
                const loc = campusLocations[key];
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'loc-entry mb-2';

                // Primary Button (Department Name)
                const primaryBtn = document.createElement('button');
                primaryBtn.textContent = loc.name;
                primaryBtn.className = `w-full text-left p-2 rounded-md text-sm text-gray-700 transition duration-150 ${loc.isDept ? 'bg-indigo-50 hover:bg-indigo-100' : 'bg-purple-50 hover:bg-purple-100'} font-semibold`;
                primaryBtn.setAttribute('data-key', key);
                buttonContainer.appendChild(primaryBtn);

                if (loc.isDept) {
                    // Secondary Buttons Container (Initially hidden)
                    const secondaryMenu = document.createElement('div');
                    secondaryMenu.id = `menu-${key}`;
                    secondaryMenu.className = `mt-1 ml-4 space-y-1 ${activeDepartmentKey === key ? '' : 'hidden'}`;

                    // Services Button
                    const servicesBtn = document.createElement('button');
                    servicesBtn.textContent = 'Services ðŸ§‘â€ðŸ«';
                    servicesBtn.className = 'w-full text-left p-2 rounded-md text-xs text-white bg-green-500 hover:bg-green-600 shadow-md transition duration-150';
                    servicesBtn.onclick = () => openServicesModal(key);
                    secondaryMenu.appendChild(servicesBtn);

                    // Map (360 View) Button
                    const mapBtn = document.createElement('button');
                    mapBtn.textContent = 'Map (360Â° View) ðŸ—ºï¸';
                    mapBtn.className = 'w-full text-left p-2 rounded-md text-xs text-white bg-blue-500 hover:bg-blue-600 shadow-md transition duration-150';
                    mapBtn.onclick = () => {
                        // Move Pegman and open 360 view
                        pegmanMarker.setLatLng([loc.lat, loc.lng]);
                        pegmanMarker.setPopupContent(`Pegman reached: <b>${loc.name}</b>`);
                        map.setView([loc.lat, loc.lng], 17);
                        initPanorama(L.latLng(loc.lat, loc.lng), loc.name);
                    };
                    secondaryMenu.appendChild(mapBtn);
                    buttonContainer.appendChild(secondaryMenu);

                    // Add click handler to primary button to toggle secondary menu
                    primaryBtn.addEventListener('click', () => {
                        // Close previously open menu
                        if (activeDepartmentKey && activeDepartmentKey !== key) {
                            const prevMenu = document.getElementById(`menu-${activeDepartmentKey}`);
                            if(prevMenu) prevMenu.classList.add('hidden');
                        }
                        // Toggle current menu
                        secondaryMenu.classList.toggle('hidden');
                        activeDepartmentKey = secondaryMenu.classList.contains('hidden') ? null : key;
                    });
                    
                    departmentList.appendChild(buttonContainer);

                } else {
                    // Non-departmental buildings only move the pegman
                    primaryBtn.addEventListener('click', () => {
                        pegmanMarker.setLatLng([loc.lat, loc.lng]);
                        pegmanMarker.setPopupContent(`Pegman reached:<br><b>${loc.name}</b>`);
                        map.setView([loc.lat, loc.lng], 17);
                    });
                    buildingList.appendChild(buttonContainer);
                }
            }
        }

        document.getElementById('toggle-sidebar').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            document.getElementById('menu-content').classList.toggle('hidden');
            document.querySelectorAll('.sidebar-text').forEach(el => el.classList.toggle('hidden'));
            // Invalidate map size to redraw tiles correctly after layout change
            setTimeout(() => { map.invalidateSize(); }, 300); 
        });

    </script>
</body>
</html>

